---
import BaseLayout from "@components/base/BaseLayout.astro";
import SEO from "@components/common/SEO.astro";

export const prerender = false;

const response = await fetch('https://dog.ceo/api/breeds/image/random');
const { message: dogImage } = await response.json();
---
<BaseLayout title="Postcards">
  <SEO title="Postcards" description="Leave a message in the Postcards!" />
  <h1>Postcards</h1>
  <p style="color: #b94a48; font-weight: bold;">Code names only. Sharing of identifiable information is prohibited when writing a postcard.</p>
  <img src={dogImage} alt="Random dog" style="max-width: 200px; border-radius: 12px; margin-bottom: 1rem;" />
  <form id="guestbook-form" style="margin-bottom: 2rem;">
    <label for="name">Name (randomized):</label><br />
    <input id="name" name="name" type="text" readonly style="margin-bottom: 1rem;" /><br />
    <label for="message">Message:</label><br />
    <textarea id="message" name="message" rows="3" required style="width: 100%; margin-bottom: 1rem;"></textarea><br />
    <button type="submit">Post to Guestbook</button>
  </form>
  <div id="guestbook-status" style="min-height:1.5em;margin-bottom:1em;color:#31708f;font-weight:bold;"></div>
  <div id="guestbook-entries">
    <h2>Recent Messages</h2>
    <ul id="messages-list"></ul>
  </div>
  <script type="module" client:load>
    async function fetchMessages() {
      try {
        const ul = document.getElementById('messages-list');
        if (!ul) return;
        
        const res = await fetch('/api/guestbook');
        if (!res.ok) {
          console.error('Failed to fetch messages:', res.status);
          ul.innerHTML = '<li style="color: #b94a48;">Failed to load messages. Please refresh the page.</li>';
          return;
        }
        
        const messages = await res.json();
        ul.innerHTML = '';
        
        if (!Array.isArray(messages)) {
          console.error('Invalid messages format:', messages);
          ul.innerHTML = '<li style="color: #b94a48;">Invalid data format.</li>';
          return;
        }
        
        if (messages.length === 0) {
          ul.innerHTML = '<li style="color: #888; font-style: italic;">No messages yet. Be the first to post!</li>';
          return;
        }
        
        messages.reverse().forEach(entry => {
          const li = document.createElement('li');
          li.innerHTML = `<strong>${entry.name}:</strong> ${entry.message} <span style='color:#888;font-size:0.8em;'>(${new Date(entry.timestamp).toLocaleString()})</span>`;
          ul.appendChild(li);
        });
      } catch (error) {
        console.error('Error fetching messages:', error);
        const ul = document.getElementById('messages-list');
        if (ul) {
          ul.innerHTML = '<li style="color: #b94a48;">Error loading messages. Please refresh the page.</li>';
        }
      }
    }
    fetchMessages();
    document.getElementById('guestbook-form').onsubmit = async (e) => {
      e.preventDefault();
      const name = document.getElementById('name').value;
      const message = document.getElementById('message').value;
      const statusDiv = document.getElementById('guestbook-status');
      const submitButton = e.target.querySelector('button[type="submit"]');
      
      statusDiv.textContent = '';
      if (!message) {
        statusDiv.style.color = '#b94a48';
        statusDiv.textContent = 'Please enter a message.';
        return;
      }
      
      // Disable button during submission
      if (submitButton) {
        submitButton.disabled = true;
        submitButton.textContent = 'Posting...';
      }
      
      try {
        const res = await fetch('/api/guestbook', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, message })
        });
        
        const data = await res.json();
        
        if (res.ok) {
          statusDiv.style.color = '#31708f';
          statusDiv.textContent = 'Message posted successfully!';
          document.getElementById('message').value = '';
          // Refresh messages after a short delay to ensure GitHub has processed
          setTimeout(() => {
            fetchMessages();
          }, 1000);
        } else {
          statusDiv.style.color = '#b94a48';
          statusDiv.textContent = data.error || `Failed to post message (${res.status}).`;
          console.error('Post failed:', data);
        }
      } catch (error) {
        statusDiv.style.color = '#b94a48';
        statusDiv.textContent = 'Network error. Please check your connection and try again.';
        console.error('Network error:', error);
      } finally {
        // Re-enable button
        if (submitButton) {
          submitButton.disabled = false;
          submitButton.textContent = 'Post to Guestbook';
        }
      }
    };
    // Regenerate random name on page load
    document.getElementById('name').value = (function() {
      const adjectives = ["Brave", "Clever", "Gentle", "Mighty", "Quiet", "Swift", "Wise", "Happy", "Curious", "Sunny"];
      const animals = ["Bear", "Fox", "Otter", "Wolf", "Deer", "Hawk", "Rabbit", "Moose", "Lynx", "Beaver"];
      const adj = adjectives[Math.floor(Math.random() * adjectives.length)];
      const animal = animals[Math.floor(Math.random() * animals.length)];
      return adj + ' ' + animal;
    })();
  </script>
</BaseLayout>
